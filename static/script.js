const socket=io(),results=document.querySelector("#results"),openTimes=document.querySelector("#open_times"),openFilters=document.querySelector("#open_filters"),filters=document.querySelector("#filters"),times=document.querySelector("#times"),rangeInput=document.querySelector('input[type="range"]'),numberInput=document.querySelector('input[type="number"]'),sortInputsAvailability=document.querySelectorAll('#filters div:first-of-type input[type="radio"]'),sortInputs=document.querySelectorAll('#filters div:nth-of-type(2) input[type="radio"]'),errorMessage=document.querySelector("#error_message"),chargingStations=document.querySelector("#charging_stations"),loaderSection=document.querySelector("#loader"),loaderText=document.querySelector("#loader_text");
const getLocation=()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError):(errorMessage.classList.remove("hidden"),errorMessage.textContent="Your browser does not let you share your location. Maybe try in another browser.")},showPosition=o=>{var e=o.coords.latitude,o=o.coords.longitude;socket.emit("location",{latitude:e,longitude:o})},showError=o=>{o.PERMISSION_DENIED&&(errorMessage.classList.remove("hidden"),errorMessage.textContent="It seems that we don't have access to your location. Check your settings to enable us to track your location.")};
let resultsAmount=0;socket.on("fill-in-data",(e,n)=>{chargingStations.classList.remove("hidden"),loaderSection.classList.add("hidden"),loaderText.classList.add("hidden");let a=changeSupplierOnAvailibitlySort(e),i=changeDistanceOnAvailibitlySort(n);sortInputsAvailability.forEach(t=>{t.addEventListener("click",()=>{chargingStations.textContent="",a=changeSupplierOnAvailibitlySort(e),i=changeDistanceOnAvailibitlySort(n),sortInputs[0].checked?fillInChargingStationsBySupplier(a):sortInputs[1].checked&&fillInChargingStationsByDistance(i,a),results.textContent=resultsAmount+" results"})}),sortInputs.forEach(t=>{t.addEventListener("click",t=>{chargingStations.textContent="";t=t.target.id;"sustainability"==t?fillInChargingStationsBySupplier(a):"distance"==t&&fillInChargingStationsByDistance(i,a)})}),rangeInput.addEventListener("input",()=>{chargingStations.textContent="",sortInputs[0].checked?fillInChargingStationsBySupplier(a):sortInputs[1].checked&&fillInChargingStationsByDistance(i,a),results.textContent=resultsAmount+" results"}),fillInChargingStationsBySupplier(a),results.textContent=resultsAmount+" results"});const changeSupplierOnAvailibitlySort=t=>{let n=[];return t.map(e=>Object.keys(e).map(t=>{n.push({[t]:{value:e[t].value,stations:e[t].stations.filter(t=>sortInputsAvailability[0].checked?"Available"===t.status:sortInputsAvailability[1].checked?t:void 0)}})})),n},changeDistanceOnAvailibitlySort=t=>{let n=[];return t.map(e=>Object.keys(e).filter(t=>{(sortInputsAvailability[0].checked&&"Available"===e[t].stations.status||sortInputsAvailability[1].checked)&&n.push({[t]:{value:e[t].value,stations:e[t].stations}})})),n},fillInChargingStationsByDistance=(t,e)=>{resultsAmount=0;let n=[],a=[],i=(e.map(t=>{Object.values(t).map(t=>{n.push(t.value*t.stations.length),a.push(t.stations.length)})}),n.reduce((t,e)=>t+e,0)/a.reduce((t,e)=>t+e,0));t.map(t=>{Object.values(t).map(t=>{let e=document.createElement("p");var n=t.value;e.textContent="Sustainability score: ",n>i?e.classList.add("bad_sustainability"):n<=i&&e.classList.add("good_sustainability"),insertContent(t.stations,e)})})},fillInChargingStationsBySupplier=t=>{resultsAmount=0;let e=[],n=[],s=(Object.values(t).map(t=>{Object.values(t).map(t=>{e.push(t.value*t.stations.length),n.push(t.stations.length)})}),e.reduce((t,e)=>t+e,0)/n.reduce((t,e)=>t+e,0));return t.map(i=>Object.keys(i).map(a=>i[a].stations.map(t=>{let e=document.createElement("p");e.textContent="Sustainability score: ";var n=i[a].value;n>s?e.classList.add("bad_sustainability"):n<=s&&e.classList.add("good_sustainability"),insertContent(t,e)})))},insertContent=(u,d)=>{if(u.distance<rangeInput.value){resultsAmount++;var p=u.coordinates.latitude,g=u.coordinates.longitude;let t=document.createElement("article"),e=document.createElement("h2"),n=document.createElement("p"),a=document.createElement("button"),i=document.createElement("div"),s=document.createElement("p"),l=document.createElement("p"),r=document.createElement("p"),o=document.createElement("p"),c=document.createElement("a");var h=u.address.map(t=>{if(t.id.includes("address"))return t.text}).filter(t=>t);return"Available"!==u.status&&t.classList.add("unavailable"),e.textContent=h[0],n.textContent=u.distance+" meters",a.textContent="i",i.setAttribute("id","extra_info_container"),i.classList.add("hidden"),s.textContent="Operator: "+u.operatorName,l.textContent="Provider: "+u.provider,r.textContent="Current status: "+u.status,o.textContent=`Maximum charging power: ${u.maxPower}kW`,c.setAttribute("href",`http://www.google.com/maps/place/${p},`+g),c.setAttribute("target","_blank"),c.textContent="Start route",t.addEventListener("click",e=>{if(window.innerHeight-e.clientY<250&&i.classList.contains("hidden")){let t=e.target;(t="article"!==t.nodeName.toLowerCase()?e.target.parentElement:t).scrollIntoView({behavior:"smooth",block:"center"})}"a"!==e.target.tagName.toLowerCase()&&i.classList.toggle("hidden")}),0<h.length&&(i.append(s,l,r,o,c),t.append(e,n,d,a,i),chargingStations.appendChild(t)),chargingStations}};
const addEventListeners=()=>{openFilters.addEventListener("click",()=>{openFilters.classList.toggle("active"),filters.classList.toggle("hidden"),openFilters.classList.contains("active")&&(openTimes.classList.remove("active"),times.classList.add("hidden"))}),openTimes.addEventListener("click",()=>{openTimes.classList.toggle("active"),times.classList.toggle("hidden"),openTimes.classList.contains("active")&&(openFilters.classList.remove("active"),filters.classList.add("hidden"))}),rangeInput.addEventListener("input",e=>{let s=e.target;numberInput.value=s.value;var e=s.min,t=s.max,i=s.value;s.style.backgroundSize=100*(i-e)/(t-e)+"% 100%";let n=Number(s.style.backgroundSize.split("%")[0])/50;0===n?n=1:.4===n?n=1.2:.8===n?n=1.4:1.2===n?n=1.6:1.6===n?n=1.8:2===n&&(n=2),rangeInput.style.setProperty("--slider-size",n+"rem")})};
"/search"==window.location.pathname&&(getLocation(),addEventListeners());